<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Zone</title>
<style>
  .panel { display: none; border: 1px solid #ccc; padding: 16px; margin-top: 20px; }
  .gun-row label { display: block; margin: 4px 0; }
  .btn { padding: 8px 12px; margin: 4px; cursor: pointer; }
  .btn-ghost { background: #f0f0f0; border: 1px solid #ccc; }
  .btn-primary { background: #007bff; color: white; border: none; }
  #form-message { margin: 8px 0; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
  <!-- Left: selection -->
  <div class="card">
    <div class="brand">
      <h1>BGMI & Free Fire Match War</h1>
      <p class="lead">Pick match size, choose winning system for team matches, then configure settings and join.</p>
    </div>

    <div class="modes" id="modeSection">
      <div class="mode-tile" onclick="openMatchForm('1v1')"><h3>1v1</h3><p>Solo vs Solo</p></div>
      <div class="mode-tile" onclick="openMatchForm('2v2')"><h3>2v2</h3><p>Duo Battles</p></div>
      <div class="mode-tile" onclick="openMatchForm('3v3')"><h3>3v3</h3><p>Triple Team War</p></div>
      <div class="mode-tile" onclick="openMatchForm('4v4')"><h3>4v4</h3><p>Squad Fight</p></div>
    </div>

    <div id="prizeSystemSection" style="display:none;text-align:center">
      <h3>Select Winning System</h3>
      <div class="modes" style="grid-template-columns:repeat(2,1fr);">
        <div class="mode-tile" onclick="selectPrizeSystem('kill_based')"><h3>Kill-Based</h3></div>
        <div class="mode-tile" onclick="selectPrizeSystem('team_equal')"><h3>Team Equal</h3></div>
      </div>
      <button class="btn btn-ghost" onclick="backToModes()">⬅ Back</button>
    </div>

    <div class="small-note">More updates coming soon.</div>
  </div>

  <!-- Right: form -->
  <div class="panel" role="region" aria-labelledby="join-title">
    <h2 id="join-title">Join Match</h2>
    <p id="form-message"></p>

    <form id="matchForm" onsubmit="return false;">
      <input type="hidden" id="type" />
      <input type="hidden" id="prizeSystem" />

      <label>Game</label>
      <select id="game" onchange="updateGameOptions()">
        <option value="">Select Game</option>
        <option value="Free Fire">Free Fire</option>
        <option value="BGMI">BGMI (Coming Soon)</option>
      </select>

      <label>Mode</label>
      <select id="mode" onchange="updateMapOptions()"></select>

      <div id="mapSection" style="display:none">
        <label>Map</label>
        <select id="map"></select>
      </div>

      <div class="field">
        <label for="rounds">Rounds</label>
        <select id="rounds">
          <option value="">Select rounds</option>
          <option value="7">7</option>
          <option value="9">9</option>
          <option value="11">11</option>
          <option value="13">13</option>
          <option value="15">15</option>
        </select>
      </div>

      <div id="freeFireFields">
        <label>Headshot</label>
        <select id="headshot">
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>

        <label>Character Skill</label>
        <select id="characterSkill">
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>

        <label>Gun Attributes</label>
        <select id="gunAttributes">
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>

        <label>Throwable Limit</label>
        <select id="throwableLimit">
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>

        <label>Room Type</label>
        <select id="roomType" onchange="toggleGunSelection()">
          <option value="Regular">Regular</option>
          <option value="Advance">Advance</option>
        </select>

        <div id="gunSelection">
          <div id="gunsList" class="gun-row"></div>
        </div>
      </div>

      <label>Game UID</label>
      <input id="uid" type="text" placeholder="Enter your game UID" />

      <label>WhatsApp number</label>
      <div class="inline">
        <select id="countryCode">
          <option value="+91">+91 (India)</option>
          <option value="+1">+1 (USA)</option>
          <option value="+44">+44 (UK)</option>
          <option value="+61">+61 (AUS)</option>
        </select>
        <input id="whatsappNumber" type="text" placeholder="e.g. 9876543210" />
      </div>

      <div class="form-row">
        <label>Entry Fee (₹)</label>
        <select id="fee" onchange="toggleCustomFee()">
          <option value="50">₹50</option>
          <option value="100">₹100</option>
          <option value="150">₹150</option>
          <option value="200">₹200</option>
          <option value="custom">Custom</option>
        </select>
        <input type="number" id="entryFee" placeholder="Enter custom fee" min="50" style="display:none; margin-top:8px;" />
      </div>

      <div class="controls">
        <button id="joinBtn" class="btn btn-primary" onclick="joinMatch()">Join Match</button>
        <button type="button" class="btn btn-ghost" onclick="showHome()">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  const API_BASE = "https://battlepurse-88.onrender.com/api/wallet";
const token = localStorage.getItem('token');
const UPLOADS_BASE = "https://battlepurse-88.onrender.com/uploads";
const BACKEND_URL = API_BASE;
/* =========================
   JS CODE (functions + logic)
========================= */
let selectedType = '';
let selectedPrizeSystem = null;

const BGMI_MODES = ["TDM", "Gun Game"];
const FF_MODES = ["Clash Squad", "Lone Wolf"];
const CLASH_SQUAD_MAPS = ["Bermuda","Alpine","Kalahari","Purgatory","Nexterra"];
const LONE_WOLF_MAPS = ["Iron Cage"];
const ALLOWED_ROUNDS = [7,9,11,13,15];

const GUN_CATEGORIES = {
  AR: ["AK","M4A1","SCAR","GROZA","FAMAS","AN94","XM8","M14","PARAFAL","KINGFISHER","AUG","AC80"],
  SMG: ["MP40","MP5","UMP","VSS","THOMPSON","VECTOR","BIZON","UZI","MAC10"],
  SNIPER: ["AWM","KAR98K","M82B","M24","SVD","SKS","WOODPECKER"],
  SHOTGUN: ["M1014","M1887","MAG7","SPAS12","Trogon"],
  PISTOLS: ["USP","G18","M500","Desert Eagle","Treatment Pistol","Hand Cannon"],
  LAUNCHERS: ["M79","RGS50","MGL140"],
  SPECIAL: ["Plasma Gun","Laser Gun (CS)","CG15","Crossbow","Flame Bow"]
};

const modeSection = document.getElementById('modeSection');
const prizeSystemSection = document.getElementById('prizeSystemSection');
const formMessage = document.getElementById('form-message');

const gameEl = document.getElementById('game');
const modeEl = document.getElementById('mode');
const mapSection = document.getElementById('mapSection');
const mapEl = document.getElementById('map');

const freeFireFields = document.getElementById('freeFireFields');
const roomTypeEl = document.getElementById('roomType');
const gunSelection = document.getElementById('gunSelection');
const gunsList = document.getElementById('gunsList');

const uidEl = document.getElementById('uid');
const countryCodeEl = document.getElementById('countryCode');
const whatsappEl = document.getElementById('whatsappNumber');

const feeEl = document.getElementById('fee');
const customFeeEl = document.getElementById('entryFee');
const joinBtn = document.getElementById('joinBtn');

/* =========================
   Helper functions
========================= */
function show(el){if(el) el.style.display='block';}
function hide(el){if(el) el.style.display='none';}
function setMessage(txt,danger=true){if(formMessage){formMessage.textContent=txt||'';formMessage.style.color=danger?'red':'green';}}

function getFinalEntryFee(){
  if(!feeEl) return null;
  const selected = feeEl.value;
  if(!selected){ setMessage("Please select entry fee"); return null; }
  if(selected==="custom"){ 
    const val=parseFloat(customFeeEl.value);
    if(isNaN(val)||val<50){ setMessage("Custom entry fee must be at least ₹50"); joinBtn.disabled=true; joinBtn.style.opacity="0.5"; return null;}
    joinBtn.disabled=false; joinBtn.style.opacity="1"; setMessage(''); return val;
  }
  const fee=parseFloat(selected);
  if(isNaN(fee)||fee<50){ setMessage("Invalid entry fee"); joinBtn.disabled=true; joinBtn.style.opacity="0.5"; return null; }
  joinBtn.disabled=false; joinBtn.style.opacity="1"; setMessage(''); return fee;
}

function toggleCustomFee(){
  if(feeEl.value==="custom"){ show(customFeeEl); customFeeEl.value=''; customFeeEl.focus(); joinBtn.disabled=true; joinBtn.style.opacity='0.5'; }
  else { hide(customFeeEl); customFeeEl.value=''; joinBtn.disabled=false; joinBtn.style.opacity='1'; setMessage(''); }
}

/* =========================
   Game/Mode/Map
========================= */
function updateGameOptions(){
  if(!gameEl||!modeEl||!mapEl) return;
  const g=gameEl.value;
  modeEl.innerHTML=''; mapEl.innerHTML='';
  if(g==='BGMI'||g==='PUBG'){ BGMI_MODES.forEach(m=>{const o=document.createElement('option');o.value=o.textContent=m; modeEl.appendChild(o);}); hide(freeFireFields); hide(mapSection); }
  else if(g==='Free Fire'){ FF_MODES.forEach(m=>{const o=document.createElement('option');o.value=o.textContent=m; modeEl.appendChild(o);}); show(freeFireFields); show(mapSection); }
  else { hide(freeFireFields); hide(mapSection);}
  updateMapOptions(); toggleGunSelection();
}

function updateMapOptions(){
  if(!mapEl) return; mapEl.innerHTML='';
  if(gameEl.value!=='Free Fire'){ hide(mapSection); return; }
  show(mapSection);
  const maps=modeEl.value==='Clash Squad'?CLASH_SQUAD_MAPS:LONE_WOLF_MAPS;
  maps.forEach(mp=>{ const o=document.createElement('option'); o.value=o.textContent=mp; mapEl.appendChild(o); });
}

function toggleGunSelection(){
  if(!gunSelection||!gunsList) return;
  if(roomTypeEl.value==='Advance'){ show(gunSelection); gunsList.innerHTML=''; for(const cat in GUN_CATEGORIES){ const catLabel=document.createElement('div'); catLabel.style.fontSize='12px'; catLabel.style.color='#999'; catLabel.textContent=cat; gunsList.appendChild(catLabel); GUN_CATEGORIES[cat].forEach(g=>{const id='g_'+g.replace(/\s+/g,'_'); const label=document.createElement('label'); label.innerHTML=`<input type="checkbox" id="${id}" value="${g}"> ${g}`; gunsList.appendChild(label); }); } }
  else{ hide(gunSelection); gunsList.innerHTML=''; }
}

/* =========================
   Form control functions
========================= */
function openMatchForm(type){ selectedType=type; document.getElementById('type').value=type; if(type==='1v1'){selectedPrizeSystem='kill_based'; document.getElementById('prizeSystem').value=selectedPrizeSystem; hide(prizeSystemSection); showForm();} else { show(prizeSystemSection); hide(modeSection);} }
function selectPrizeSystem(ps){ selectedPrizeSystem=ps; document.getElementById('prizeSystem').value=ps; hide(prizeSystemSection); showForm(); }
function backToModes(){ hide(prizeSystemSection); show(modeSection); }
function showHome(){ selectedType=''; selectedPrizeSystem=null; hide(document.querySelector('.panel')); show(modeSection); setMessage(''); }
function showForm(){ updateGameOptions(); setMessage(''); document.querySelector('.panel').style.display='block'; document.getElementById('join-title').textContent = selectedType?`Join ${selectedType} Match`:'Join Match'; window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'}); }

/* =========================
   Join Match
========================= */
async function joinMatch(){
  setMessage('');
  if(!selectedType){ setMessage('❌ Select match type'); return;}
  if(!selectedPrizeSystem){ setMessage('❌ Select prize system'); return;}
  const game=gameEl.value; const mode=modeEl.value; const rounds=Number(document.getElementById('rounds')?.value);
  const uid=uidEl.value.trim(); const countryCode=countryCodeEl.value.trim(); const whatsappRaw=whatsappEl.value.replace(/[\s-]/g,'').trim();
  const roomType=roomTypeEl.value; const map=mapEl.value||undefined;
  if(!uid){ setMessage('❌ Enter your Game UID'); return;}
  if(!countryCode.startsWith('+')){ setMessage('❌ Invalid country code'); return;}
  if(!/^\d{10,15}$/.test(whatsappRaw)){ setMessage('❌ Invalid WhatsApp number'); return;}

  const finalEntryFee = getFinalEntryFee(); if(finalEntryFee===null) return;

  const selectedGuns=[];
  if(game==='Free Fire' && roomType==='Advance'){ document.querySelectorAll('#gunsList input[type=checkbox]:checked').forEach(cb=>selectedGuns.push(cb.value)); }

  const headshot=document.getElementById('headshot')?.value==='true';
  const characterSkill=document.getElementById('characterSkill')?.value==='true';
  const gunAttributes=document.getElementById('gunAttributes')?.value==='true';
  const throwableLimit=Number(document.getElementById('throwableLimit')?.value||0);

  const payload={ type:selectedType, game, mode, rounds, fee:finalEntryFee, uid, prizeSystem:selectedPrizeSystem, countryCode, whatsappNumber:whatsappRaw, map, roomType, headshot, characterSkill, gunAttributes, throwableLimit, selectedGuns };

  try{
    setMessage('⏳ Joining match...', false);
    const res=await fetch(`${API_BASE}/joins`,{ method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+TOKEN}, body:JSON.stringify(payload) });
    const data=await res.json();
    if(res.ok && data.success){ setMessage(`✅ Joined successfully! ₹${finalEntryFee} deducted.`, false); const redirectUrl=data.redirectUrl||(data.match?._id?`user-room.html?matchId=${data.match._id}`:null); if(redirectUrl) window.location.href=redirectUrl; }
    else{ setMessage('❌ '+(data.msg||'Something went wrong'), true);}
  }catch(err){ console.error(err); setMessage('❌ Network error: '+(err.message||'Join failed'));}
}

/* =========================
   Init
========================= */
(function init(){
  updateGameOptions(); hide(prizeSystemSection);
  feeEl.addEventListener("change", toggleCustomFee);
  customFeeEl.addEventListener("input", ()=>{
    const val=parseFloat(customFeeEl.value);
    if(val>=50){ joinBtn.disabled=false; joinBtn.style.opacity='1'; setMessage(''); } else { joinBtn.disabled=true; joinBtn.style.opacity='0.5'; setMessage("Minimum custom entry fee is ₹50"); }
  });
})();

/* =========================
   Export functions globally
========================= */
window.openMatchForm=openMatchForm;
window.selectPrizeSystem=selectPrizeSystem;
window.backToModes=backToModes;
window.showHome=showHome;
window.showForm=showForm;
window.updateGameOptions=updateGameOptions;
window.updateMapOptions=updateMapOptions;
window.toggleGunSelection=toggleGunSelection;
window.toggleCustomFee=toggleCustomFee;
window.joinMatch=joinMatch;
</script>

</body>
</html>
