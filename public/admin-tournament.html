<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin | Tournament Players & Management</title>
  <style>
    body {
      background: #0a0a0a;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      padding: 20px;
      text-align: center;
    }
    h1, h2, h3 { color: #00faff; text-shadow: 0 0 10px #00faff; }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      border: 1px solid #00faff44;
      background: #111;
      box-shadow: 0 0 15px #00faff33;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #00faff22;
      text-align: left;
    }
    th {
      background: #00faff33;
      color: #00faff;
      text-transform: uppercase;
      font-size: 14px;
      letter-spacing: 1px;
    }
    tr:hover { background: #00faff11; transition: 0.3s; }
    .paid { color: #00ff6a; font-weight: bold; }
    .unpaid { color: #ff004c; font-weight: bold; }
    .container { margin-top: 20px; }
    .back-btn {
      display: inline-block;
      background: #00faff;
      color: #000;
      padding: 10px 20px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      margin-bottom: 20px;
      transition: 0.3s;
    }
    .back-btn:hover { background: #00bfa5; }
    .section {
      margin: 30px 0;
      padding: 20px;
      background: #111;
      border-radius: 10px;
      text-align: left;
    }
    input, select, textarea { width: 100%; padding: 8px; margin-top: 5px; border-radius: 5px; border: none; }
    button { margin-top: 10px; padding: 10px; background: #00faff; color: #000; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #00bfa5; }
    img { max-width: 200px; border-radius: 5px; margin-top: 5px; }
    /* Results Cards */
    .result-card { border:1px solid #444; padding:10px; margin:10px 0; border-radius:8px; background:#111; }
    .result-card img { max-width:100%; border-radius:5px; margin-top:5px; }
    .result-card select, .result-card button { margin-top:10px; padding:8px 12px; border-radius:5px; border:none; cursor:pointer; }
    .result-card button { background:#00c853; color:#fff; }
    .result-card button:hover { background:#009624; }
    .result-card select { background:#222; color:#fff; }


    /* Swipe detection edge */
.swipe-area {
  position: fixed;
  left: 0;
  top: 0;
  width: 28px;
  height: 100%;
  z-index: 9998;
}

/* Swipe arrow */
.swipe-arrow {
  position: fixed;
  left: -40px;
  top: 50%;
  transform: translateY(-50%);
  width: 36px;
  height: 36px;
  background: rgba(0,0,0,0.7);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  box-shadow: 0 0 12px rgba(0,234,255,0.6);
  transition: left 0.15s ease, opacity 0.15s ease;
  opacity: 0;
  z-index: 9999;
}









/* Poster Upload Styles */
.poster-title {
  text-align: center;
  margin: 20px 0;
  font-size: 24px;
  color: #00cfff;
  text-shadow: 0 0 10px rgba(0, 207, 255, 0.7);
}

.poster-form {
  max-width: 400px;
  margin: 0 auto 40px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.poster-form label {
  font-weight: bold;
  color: #a9dfff;
}

.poster-form input, .poster-form select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #12314d;
  background: #030914;
  color: #e8f7ff;
}

.btn-upload {
  padding: 10px;
  background: linear-gradient(90deg, #00cfff, #0055ff);
  border: none;
  color: #fff;
  font-weight: bold;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.3s;
}

.btn-upload:hover {
  background: linear-gradient(90deg, #0055ff, #00cfff);
  box-shadow: 0 0 20px #00cfff;
}

.poster-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  padding: 0 16px;
}

.poster-card {
  position: relative;
  background: linear-gradient(180deg, #0d1c33, #071221);
  border: 1px solid #12314d;
  border-radius: 16px;
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.25s, box-shadow 0.25s;
}

.poster-card:hover {
  transform: translateY(-6px) scale(1.03);
  box-shadow: 0 0 25px rgba(0, 207, 255, 0.6);
}

.poster-card img {
  width: 100%;
  height: 180px;
  object-fit: cover;
}

.poster-info {
  padding: 8px;
  font-weight: bold;
  color: #00cfff;
  text-align: center;
  text-shadow: 0 0 5px #00cfff;
  background: rgba(0, 0, 0, 0.5);
}

.delete-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: #ff4d4d;
  border: none;
  color: #fff;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
  font-size: 12px;
  transition: 0.2s;
}

.delete-btn:hover {
  background: #ff1a1a;
  box-shadow: 0 0 10px #ff4d4d;
}

  </style>
</head>
<body>
  <!-- Swipe-back edge -->
<div class="swipe-area"></div>

<!-- Swipe arrow -->
<div class="swipe-arrow">‚Üê</div>


<h1>üèÜ Tournament Player List & Admin Panel</h1>
<a href="admin.html" class="back-btn">‚Üê Back to Dashboard</a>

<!-- Tournament Info -->
<div id="tournamentInfo"></div>

<!-- Player Table -->
<div class="container">
  <table id="playerTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Player Name</th>
        <th>Mobile</th>
        <th>Game UIDs</th>
        <th>Wallet</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="playerBody">
      <tr><td colspan="6">Loading players...</td></tr>
    </tbody>
  </table>
</div>

<!-- Create Tournament -->
<div class="section">
  <h3>Create Tournament</h3>
  <form id="createForm" enctype="multipart/form-data">
    <label>Name</label>
    <input type="text" name="name" required>
    <label>Game</label>
    <input type="text" name="game" required>
    <label>Mode</label>
    <input type="text" name="mode" required>
    <label>Date</label>
    <input type="date" name="date" required>
    <label>Time</label>
    <input type="time" name="time" required>
    <label>Entry Fee</label>
    <input type="number" name="entryFee" required>
    <label>Prize Pool</label>
    <input type="number" name="prizePool" required>
    <label>Max Players</label>
    <input type="number" name="maxPlayers" required>
    <label>Description</label>
    <textarea name="description"></textarea>
    <label>Upload Poster</label>
    <input type="file" name="poster" accept="image/*" required>
    <button type="submit">Create Tournament</button>
  </form>
</div>

<!-- Upload Room Info -->
<div class="section">
  <h3>Upload Room ID & Password</h3>
  <form id="roomForm">
    <label>Select Tournament</label>
    <select id="roomTournamentSelect" name="tournamentId" required></select>
    <label>Room ID</label>
    <input type="text" name="roomId" required>
    <label>Room Password</label>
    <input type="text" name="roomPassword" required>
    <button type="submit">Upload Room Info</button>
  </form>
</div>

<!-- Review Player Results -->
<div class="section">
  <h3>Admin: Tournament Results</h3>
  <label>Select Tournament</label>
  <select id="resultTournamentSelect" onchange="loadResults(this.value)"></select>
  <div id="results">No results yet.</div>
</div>

<!-- Tournament List -->
<div class="section">
  <h3>All Tournaments</h3>
  <div id="tournamentList"></div>
</div>

<!-- Promo Management -->
 <div class="section">
  <h3>Promo Management</h3>
  <form id="promoForm" enctype="multipart/form-data">
    <input type="text" id="promoTitle" name="title" placeholder="Promo Title" required><br><br>
    <input type="file" id="promoImages" name="images" multiple accept="image/*" required><br><br>
    <button type="submit">Add Promo</button>
  </form>
  <h4>All Promos</h4>
  <div id="promoList"></div>
</div>




<h1 class="poster-title">Admin - Upload Poster</h1>

<form id="posterForm" class="poster-form">
  <label for="game">Select Game</label>
  <select id="game" required>
    <option value="">Select Game</option>
    <option value="Free Fire">Free Fire</option>
    <option value="BGMI">BGMI</option>
  </select>

  <label for="image">Select Poster Image</label>
  <input type="file" id="image" accept="image/*" required>

  <button type="submit" class="btn-upload">Upload Poster</button>

  <div class="message" id="message"></div>
</form>

<h2 class="poster-title">Uploaded Posters</h2>
<div id="posterGrid" class="poster-grid"></div>


<script>
const token = localStorage.getItem("token") || "YOUR_ADMIN_TOKEN_HERE";
const params = new URLSearchParams(window.location.search);
const tournamentId = params.get("id");

const API_URL = `https://battlepurse-88.onrender.com/api/wallet/tournaments`;
const RESULT_URL = `https://battlepurse-88.onrender.com/api/wallet/results`;
const GAME_URL = `https://battlepurse-88.onrender.com/api/wallet`;
const PROMO_URL = `https://battlepurse-88.onrender.com/api/wallet/promos`;
const UPLOADS_BASE = "https://battlepurse-88.onrender.com/uploads";
const API_BASE = "http://localhost:5000/api/wallet";

let assignedPositions = new Set();

/* ---------------- Load Players ---------------- */


async function loadPlayers() {
  if (!tournamentId) return;
  try {
    const res = await fetch(`${API_URL}/${tournamentId}/players`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();

    if (!res.ok) return alert(data.msg || "Failed to load players");

    document.getElementById("tournamentInfo").innerHTML = `
      <h2>${data.tournamentName}</h2>
      <p>üéÆ ${data.game} | Mode: <strong>${data.mode}</strong></p>
      <p>Total Players: <strong>${data.totalPlayers}</strong></p>
    `;

    const tbody = document.getElementById("playerBody");
    tbody.innerHTML = data.players.length
      ? data.players.map((p, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${p.name}</td>
          <td>${p.phone}</td>
          <td>${(p.gameUIDs && p.gameUIDs.length ? p.gameUIDs.join(", ") : "‚Äî")}</td>
          <td>‚Çπ${p.wallet}</td>
          <td class="${p.paid ? "paid" : "unpaid"}">${p.paid ? "Paid" : "Unpaid"}</td>
        </tr>
      `).join("")
      : `<tr><td colspan="6" style="text-align:center;">No players joined yet.</td></tr>`;
  } catch (err) {
    console.error(err);
    alert("Error loading players");
  }
}

/* ---------------- Create Tournament ---------------- */
/* ---------------- Games ---------------- */
async function loadGames() {
  try {
    const res = await fetch(GAME_URL, { headers: { Authorization: `Bearer ${token}` } });
    const games = await res.json();
    document.getElementById("gameSelect").innerHTML =
      games.map(g => `<option value="${g._id}">${g.name}</option>`).join('');
  } catch (err) { console.error("Failed to load games", err); }
}

/* ---------------- Tournaments ---------------- */
async function loadTournaments() {
  try {
    const res = await fetch(API_URL, { headers: { Authorization: `Bearer ${token}` } });
    const tournaments = await res.json();

    const container = document.getElementById('tournamentList');
    const roomSelect = document.getElementById('roomTournamentSelect');
    const resultSelect = document.getElementById('resultTournamentSelect');

    container.innerHTML = '';
    roomSelect.innerHTML = '';
    resultSelect.innerHTML = '';

    if (!tournaments.length) {
      container.innerHTML = "<p>No tournaments found.</p>";
      return;
    }

    tournaments.forEach(t => {
      container.innerHTML += `
        <div style="border:1px solid #ccc; padding:10px; margin:10px;">
          ${t.poster ? `<img src="${UPLOADS_BASE}/${t.poster}" alt="Poster" width="150">` : ""}
          <strong>${t.name}</strong><br>
          Game: ${t.gameId?.name || 'N/A'} <br>
          Entry Fee: ‚Çπ${t.entryFee}<br>
          Prize Pool: ‚Çπ${t.prizePool}<br>
          Max Players: ${t.maxPlayers}<br>
          Date: ${new Date(t.date).toLocaleDateString()}<br>
          Time: ${t.time}<br>
          <button onclick="deleteTournament('${t._id}')">Delete</button>
        </div>
      `;
      roomSelect.innerHTML += `<option value="${t._id}">${t.name}</option>`;
      resultSelect.innerHTML += `<option value="${t._id}">${t.name}</option>`;
    });
  } catch (err) { console.error("Error loading tournaments", err); }
}

async function deleteTournament(id) {
  if (confirm("Delete this tournament?")) {
    const res = await fetch(`${API_URL}/${id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` }
    });
    const data = await res.json();
    alert(data.msg || "Deleted");
    loadTournaments();
  }
}

document.getElementById("createForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { Authorization: `Bearer ${token}` },
      body: formData
    });
    const data = await res.json();

    if (res.ok) {
      alert("Tournament created successfully");
      e.target.reset();
      loadTournaments();
    } else {
      alert(data.msg || "Failed to create tournament");
    }
  } catch (err) { console.error(err); alert("Error submitting tournament"); }
});
/* ---------------- Load Results ---------------- */
async function loadResults(tournamentId){
  if(!tournamentId) return;
  try{
    const res = await fetch(`${RESULT_URL}/${tournamentId}`, { headers:{ Authorization:`Bearer ${token}` } });
    const data = await res.json();
    const resultsDiv = document.getElementById("results");

    if(!res.ok){ resultsDiv.innerHTML=`<p>Error: ${data.msg || "Failed to load results."}</p>`; return; }
    if(!data.results || !data.results.length){ resultsDiv.innerHTML="<p>No screenshots uploaded yet.</p>"; return; }

    resultsDiv.innerHTML = data.results.map(r=>{
      const options = [1,2,3].map(pos=>`<option value="${pos}" ${assignedPositions.has(pos)?"disabled":""}>${pos} ${pos===1?"ü•á":pos===2?"ü•à":"ü•â"}</option>`).join("");
      return `
        <div class="result-card" id="player-${r.user?.id}">
          <p><strong>Player:</strong> ${r.user?.name || "Unknown"}</p>
          <p><strong>Phone:</strong> ${r.user?.phone || "N/A"}</p>
          <p><strong>Email:</strong> ${r.user?.email || "N/A"}</p>
          <p><strong>Uploaded At:</strong> ${new Date(r.uploadedAt).toLocaleString()}</p>
          ${r.screenshot ? `<img src="${r.screenshot}"/>`:"<p>No screenshot</p>"}
          <select id="pos-${r.user?.id}"><option value="">Select Rank</option>${options}</select>
          <button onclick="declareWinner('${tournamentId}','${r.user?.id}')">Declare Winner</button>
        </div>
      `;
    }).join("");
  }catch(err){ console.error(err); document.getElementById("results").innerHTML="<p>Failed to load results.</p>"; }
}

async function declareWinner(tournamentId,userId){
  const posSelect = document.getElementById(`pos-${userId}`);
  const position = parseInt(posSelect.value);
  if(!position){ alert("Select a rank before declaring."); return; }
  if(assignedPositions.has(position)){ alert("This rank has already been assigned."); return; }

  try{
    const res = await fetch(`${GAME_URL}/declareWinner/${tournamentId}`, {
      method:"POST",
      headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` },
      body:JSON.stringify({ winners:[{userId, position}] })
    });
    const data = await res.json();
    alert(data.msg || "Winner declared");
    assignedPositions.add(position);
    posSelect.disabled = true;
    loadResults(tournamentId);
  }catch(err){ console.error(err); alert("Failed to declare winner."); }
}

/* ---------------- Room Info ---------------- */
document.getElementById("roomForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const formData = new FormData(e.target);
  const id = formData.get("tournamentId");
  const payload = { roomId: formData.get("roomId"), roomPassword: formData.get("roomPassword") };
  try {
    const res = await fetch(`${API_URL}/${id}/room`, { method:"PUT", headers:{ "Content-Type":"application/json", Authorization:`Bearer ${token}` }, body:JSON.stringify(payload) });
    const data = await res.json();
    alert(data.msg || "Room info uploaded");
  } catch(err){ console.error(err); alert("Failed to upload room info"); }
});



/* ---------------- Other features like promos, rooms, create tournament ---------------- */
/* ...keep your existing promoForm, roomForm, createForm code here... */
/* ---------------- Promos ---------------- */
document.getElementById("promoForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const formData = new FormData();
  formData.append("title", document.getElementById("promoTitle").value);
  const files = document.getElementById("promoImages").files;
  for(let f of files) formData.append("images", f);
  try{
    const res = await fetch(PROMO_URL, { method:"POST", headers:{ Authorization:`Bearer ${token}` }, body:formData });
    const data = await res.json();
    alert(res.ok ? "Promo added!" : data.error || "Failed");
    loadPromos();
  }catch(err){ console.error(err); alert("Error adding promo"); }
});

async function loadPromos(){
  try{
    const res = await fetch(PROMO_URL, { headers:{ Authorization:`Bearer ${token}` }});
    const promos = await res.json();
    const promoList = document.getElementById("promoList");
    promoList.innerHTML = promos.length
      ? promos.map(p=>`<div style="border:1px solid #444; padding:10px; margin:10px;">
          <strong>${p.title}</strong><br>
          ${p.images.map(img=>`<img src="${UPLOADS_BASE}/${img}" style="max-width:150px;margin:5px;">`).join('')}
          <br><button onclick="deletePromo('${p._id}')">Delete</button>
        </div>`).join('')
      : "<p>No promos available.</p>";
  }catch(err){ console.error(err); }
}

async function deletePromo(id){
  if(!confirm("Delete this promo?")) return;
  const res = await fetch(`${PROMO_URL}/${id}`, { method:"DELETE", headers:{ Authorization:`Bearer ${token}` }});
  const data = await res.json();
  alert(data.msg || "Deleted");
  loadPromos();
}
/* ---------------- Init ---------------- */
loadPlayers();
loadTournaments();
loadPromos(); // make sure this function exists from your previous code



let startX = 0;
let startY = 0;
const arrow = document.querySelector(".swipe-arrow");

/* BACK LOGIC */
function goBack() {
  if (document.referrer && document.referrer !== location.href) {
    history.back();
  } else {
    location.href = "gamezone.html"; // fallback
  }
}

/* TOUCH START */
document.addEventListener("touchstart", e => {
  const x = e.touches[0].clientX;
  const y = e.touches[0].clientY;

  if (x < 30) { // left edge
    startX = x;
    startY = y;
    arrow.style.opacity = "1";
  }
});

/* TOUCH MOVE */
document.addEventListener("touchmove", e => {
  if (!startX) return;

  const moveX = e.touches[0].clientX - startX;
  if (moveX > 0) {
    arrow.style.left = Math.min(moveX - 20, 40) + "px";
  }
});

/* TOUCH END */
document.addEventListener("touchend", e => {
  const endX = e.changedTouches[0].clientX;
  const endY = e.changedTouches[0].clientY;

  const diffX = endX - startX;
  const diffY = Math.abs(endY - startY);

  // Reset arrow
  arrow.style.left = "-40px";
  arrow.style.opacity = "0";

  if (startX < 30 && diffX > 90 && diffY < 60) {
    goBack();
  }

  startX = 0;
});








/* ---------------- Poster Upload ---------------- */


/* ---------------- Poster Upload & Management ---------------- */

// üîê READ admin token (DO NOT hardcode in production)
const TOKEN =
  localStorage.getItem("adminToken") ||
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY4NWQ3MjNkYmE3YjJmY2Q2NDhlZWViYyIsImlzQWRtaW4iOnRydWUsImlhdCI6MTc2NzQ1MDU2NCwiZXhwIjoxNzk4OTg2NTY0fQ.t0a2bGibAzFwQKr2HasdPrA7ceATLNmZdjiB1RK8IMI";



const posterForm = document.getElementById("posterForm");
const posterGrid = document.getElementById("posterGrid");
const messageEl = document.getElementById("message");

// ------------------ UPLOAD POSTER ------------------
posterForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  messageEl.textContent = "";

  const game = document.getElementById("game").value;
  const file = document.getElementById("image").files[0];

  if (!game || !file) {
    messageEl.style.color = "red";
    return (messageEl.textContent = "Select game and image!");
  }

  const formData = new FormData();
  formData.append("game", game);
  formData.append("image", file);

  try {
    const res = await fetch(`${API_BASE}/admin/poster/upload`, {
      method: "POST",
      headers: { Authorization: "Bearer " + TOKEN },
      body: formData
    });

    const data = await res.json();
    if (!data.success) throw new Error(data.msg || "Upload failed");

    messageEl.style.color = "green";
    messageEl.textContent = "‚úÖ Poster uploaded successfully!";
    posterForm.reset();
    loadPosters();
  } catch (err) {
    console.error(err);
    messageEl.style.color = "red";
    messageEl.textContent = "‚ùå " + (err.message || "Upload failed");
  }
});

// ------------------ LOAD POSTERS ------------------
async function loadPosters() {
  try {
    const res = await fetch(`${API_BASE}/posters`);
    const data = await res.json();
    posterGrid.innerHTML = "";

    if (!data.success || data.posters.length === 0) {
      posterGrid.innerHTML =
        "<p style='grid-column:1/-1;text-align:center;'>No posters available</p>";
      return;
    }

    data.posters.forEach((poster) => {
      const card = document.createElement("div");
      card.className = "poster-card";

      card.innerHTML = `
      <img src="${API_BASE}${poster.image}" alt="${poster.game}">


        
        <div class="poster-info">${poster.game}</div>
        <button class="delete-btn">üóë Delete</button>
      `;

      // DELETE BUTTON
      card.querySelector(".delete-btn").addEventListener("click", async (e) => {
        e.stopPropagation();
        if (!confirm("Are you sure you want to delete this poster?")) return;

        try {
          const res = await fetch(`${API_BASE}/admin/poster/${poster._id}`, {
            method: "DELETE",
            headers: { Authorization: "Bearer " + TOKEN }
          });
          const result = await res.json();
          if (!result.success) throw new Error(result.msg || "Delete failed");
          loadPosters();
        } catch (err) {
          console.error(err);
          alert("‚ùå " + (err.message || "Delete failed"));
        }
      });

      // Click on poster goes to kavi.html
      card.addEventListener("click", () => {
        window.location.href = "kavi.html";
      });

      posterGrid.appendChild(card);
    });
  } catch (err) {
    console.error(err);
    posterGrid.innerHTML =
      "<p style='grid-column:1/-1;color:red;text-align:center;'>Error loading posters</p>";
  }
}

// Initial load
loadPosters();

</script>
</body>
</html>
