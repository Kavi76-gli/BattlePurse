<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Player Room</title>

<style>
:root{
  --bg:#0b0b0b;
  --card:#161616;
  --accent:#00eaff;
  --success:#22c55e;
  --danger:#ef4444;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Poppins,system-ui;
  overflow-x:hidden;
}

/* ================= APP BAR ================= */
.app-bar{
  position:sticky;
  top:0;
  height:56px;
  background:#141414;
  display:flex;
  align-items:center;
  padding:0 16px;
  box-shadow:0 2px 8px #000;
  z-index:100;
}
.app-bar button{
  background:none;
  border:none;
  color:var(--accent);
  font-size:22px;
  margin-right:12px;
  cursor:pointer;
}
.app-bar .title{
  font-size:18px;
  font-weight:600;
  color:var(--accent);
}

/* ================ SWIPE BACK ================= */
.swipe-area{
  position:fixed;
  top:0;left:0;
  width:24px;height:100%;
  z-index:50;
}

/* ================= CONTAINER ================= */
.container{
  max-width:420px;
  margin:auto;
  padding:16px;
  animation:slideIn .35s ease forwards;
}

/* ================= CARD ================= */
.card{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  margin-top:18px;
  box-shadow:0 0 15px #00000088;
}

/* ================= INPUT & BUTTON ================= */
input{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  background:#0f0f0f;
  color:#fff;
  margin-top:12px;
}

button{
  padding:10px 18px;
  border-radius:12px;
  border:none;
  font-weight:600;
  cursor:pointer;
}
.btn-primary{background:var(--accent);color:#000}
.btn-refresh{background:#6366f1;color:#fff}

/* ================= TABLE ================= */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:14px;
  background:#1f1f1f;
  border-radius:12px;
  overflow:hidden;
}
th,td{
  padding:10px;
  border-bottom:1px solid #333;
  text-align:left;
}
th{
  background:#111;
  color:var(--accent);
}
.muted{color:#9aa;font-size:13px}

/* ================= ANIMATIONS ================= */
@keyframes slideIn{
  from{transform:translateX(100%);opacity:0}
  to{transform:translateX(0);opacity:1}
}
@keyframes slideOut{
  from{transform:translateX(0);opacity:1}
  to{transform:translateX(100%);opacity:0}
}
</style>
</head>

<body>

<!-- Swipe Back Edge -->
<div class="swipe-area"></div>

<!-- App Bar -->
<div class="app-bar">
  <button onclick="goBack()">‚Üê</button>
  <div class="title">Player Room</div>
</div>

<!-- Main -->
<div class="container" id="page">

  <div id="room-box" class="card">Loading...</div>

  <input id="killsInput" type="number" placeholder="Enter Kills" style="display:none">

  <div style="text-align:center;margin-top:12px">
    <button class="btn-refresh" onclick="loadRoom()">üîÑ Refresh</button>
    <button class="btn-primary" onclick="confirmJoin()">‚úÖ Confirm</button>
  </div>

  <div id="teamTable"></div>

</div>

<script>
const matchId=new URLSearchParams(location.search).get("matchId");
let currentPrizeSystem=null;
let currentGame="";
const NON_PRIZE_GAMES=["Ludo","Carrom","8 Ball Pool","Cricket"];

function normalizePrize(raw){
  if(!raw) return null;
  const r=String(raw).toLowerCase();
  if(r.includes("kill")) return "kill_based";
  if(r.includes("team")) return "team_equal";
  return null;
}
function prizeLabel(c){
  return c==="kill_based"?"Kill Based":c==="team_equal"?"Team Equal":"";
}

async function loadRoom(){
  const box=document.getElementById("room-box");
  const table=document.getElementById("teamTable");
  const kills=document.getElementById("killsInput");
  box.innerHTML="Loading...";
  table.innerHTML="";

  try{
    const room=await fetch(`https://battlepurse-88.onrender.com/api/wallet/quickmatch/room/${matchId}`).then(r=>r.json());
    const pair=await fetch(`https://battlepurse-88.onrender.com/api/wallet/pairs/${matchId}`).then(r=>r.json());

    if(!room.success){
      box.innerHTML="<h3>Room not published yet</h3><p class='muted'>Please wait for admin</p>";
      kills.style.display="none";
      return;
    }

    currentGame=pair.game||room.room.game;
    currentPrizeSystem=normalizePrize(pair.prizeSystem||room.room.prizeSystem);

    if(NON_PRIZE_GAMES.includes(currentGame)){
      currentPrizeSystem=null;
      kills.style.display="none";
    }else{
      kills.style.display=currentPrizeSystem==="kill_based"?"block":"none";
    }

    const r=room.room;
    box.innerHTML=`
      <h3>Room Published</h3>
      ${r.roomId?`<p><b>Room ID:</b> ${r.roomId}</p>`:""}
      ${r.roomPassword?`<p><b>Password:</b> ${r.roomPassword}</p>`:""}
      ${currentPrizeSystem?`<p><b>Prize:</b> ${prizeLabel(currentPrizeSystem)}</p>`:""}
      ${r.message?`<p><b>Note:</b> ${r.message}</p>`:""}
      <button style="margin-top:18px;background:var(--success)" onclick="uploadResult()">üì§ Upload Result</button>
    `;

    renderTeamTable(pair.players||[]);

  }catch{
    box.innerHTML="<h3>Error loading room</h3>";
  }
}

function renderTeamTable(players){
  const el=document.getElementById("teamTable");
  if(!players.length){
    el.innerHTML="<p class='muted'>No players joined yet</p>";
    return;
  }
  let h=`<table><tr><th>UID</th><th>Name</th><th>Team</th></tr>`;
  const half=Math.ceil(players.length/2);
  players.forEach((p,i)=>{
    const team=p.team||(i<half?"LION":"TIGER");
    const color=team==="LION"?"#facc15":"#00eaff";
    h+=`<tr>
      <td>${p.uid||"-"}</td>
      <td>${p.name||"Unknown"}</td>
      <td style="color:${color}">${team}</td>
    </tr>`;
  });
  h+="</table>";
  el.innerHTML=h;
}

function uploadResult(){ alert("Upload logic unchanged"); }
function confirmJoin(){ alert("Participation confirmed"); }

/* Back + Swipe */
function goBack(){
  const page=document.getElementById("page");
  page.style.animation="slideOut .3s forwards";
  setTimeout(()=>history.back(),300);
}
let sx=0;
document.addEventListener("touchstart",e=>sx=e.touches[0].clientX);
document.addEventListener("touchend",e=>{
  if(sx<40 && e.changedTouches[0].clientX-sx>90) goBack();
});

loadRoom();
</script>
</body>
</html>
