<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Profile</title>

<style>
* {
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
}

body {
  margin: 0;
  background: #121212;
  color: #fff;
}

.container {
  max-width: 480px;
  margin: 20px auto 90px;
  padding: 20px;
  background: #1c1c1c;
  border-radius: 16px;
  box-shadow: 0 0 15px #00faff55;
}

/* Avatar */
.avatar {
  width: 110px;
  height: 110px;
  border-radius: 50%;
  display: block;
  margin: 10px auto;
  border: 3px solid #00faff;
  object-fit: cover;
}

.upload-btn {
  text-align: center;
  margin-bottom: 15px;
}

.upload-btn input {
  font-size: 12px;
}

/* User Info */
.user-info {
  text-align: center;
  margin-bottom: 15px;
}

.user-info div {
  margin: 5px 0;
  font-size: 14px;
}

/* Inputs */
label {
  margin-top: 14px;
  display: block;
  font-size: 13px;
  font-weight: 600;
}

input {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  background: #121212;
  color: #fff;
  margin-top: 6px;
  box-shadow: inset 0 0 5px #00faff44;
}

/* Wallet */
.wallet {
  margin: 18px 0;
  padding: 14px;
  text-align: center;
  background: #1a1a1a;
  border-radius: 12px;
  font-size: 18px;
  box-shadow: 0 0 10px #00faff66;
}

/* Buttons */
.button {
  width: 100%;
  padding: 14px;
  margin-bottom: 12px;
  border-radius: 30px;
  border: none;
  font-size: 16px;
  font-weight: 700;
  cursor: pointer;
  background: #00faff;
  color: #000;
}

.button.secondary {
  background: #444;
  color: #fff;
}

/* Admin */
#adminSection {
  display: none;
  text-align: center;
  margin-top: 20px;
}

/* Footer Nav */
footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 60px;
  background: #1e1e1e;
  display: flex;
  justify-content: space-around;
  align-items: center;
  border-top: 1px solid #333;
}

.nav-btn {
  color: #aaa;
  font-size: 13px;
  text-align: center;
  cursor: pointer;
}

.nav-btn.active {
  color: #00faff;
}
</style>
</head>

<body>

<div class="container">

  <img id="avatar-img"
       src="https://img.icons8.com/color/96/user.png"
       class="avatar">

  <div class="upload-btn">
    <input type="file" id="avatarInput" accept="image/*" onchange="uploadAvatar()">
  </div>

  <div class="user-info">
    <div><strong>Name:</strong> <span id="username">Loading...</span></div>
    <div><strong>Mobile:</strong> <span id="mobile">Loading...</span></div>
    <div><strong>Email:</strong> <span id="email">Loading...</span></div>
    <div><strong>User ID:</strong> <span id="userid">Loading...</span></div>
  </div>

  <label>Free Fire UID</label>
  <input type="text" id="ffid" disabled>

  <label>BGMI UID</label>
  <input type="text" id="bgmiid" disabled>

  <label>Carrom Pool UID</label>
  <input type="text" id="carrom" disabled>

  <label>Ludo King UID</label>
  <input type="text" id="ludo" disabled>

  <div class="wallet">
    Wallet Balance: ‚Çπ<span id="wallet">0</span>
  </div>

  <button class="button" onclick="location.href='deposite.html'">üí∞ Deposit</button>
  <button class="button" onclick="location.href='withdral.html'">üè¶ Withdraw</button>
  <button class="button secondary" onclick="location.href='transaction.html'">üìú Transaction History</button>

  <div id="adminSection">
    <h3>Admin Actions</h3>
    <button class="button" onclick="location.href='admin.html'">üëÆ Admin Panel</button>
  </div>

</div>

<footer>
  <div class="nav-btn" onclick="location.href='gamezone.html'">üéÆ<br>Game</div>
  <div class="nav-btn" onclick="location.href='history.html'">üìú<br>History</div>
  <div class="nav-btn" onclick="location.href='leaderboard.html'">üèÜ<br>Leaderboard</div>
  <div class="nav-btn active">üë§<br>Profile</div>
  <div class="nav-btn" onclick="location.href='more.html'">‚ãØ<br>More</div>
</footer>

<script>
/* ================= AUTH ================= */
const token = localStorage.getItem("token");
if (!token) {
  alert("Please login first");
  location.href = "login.html";
}

const avatarImg = document.getElementById("avatar-img");
const avatarInput = document.getElementById("avatarInput");

/* ================= LOAD PROFILE ================= */
async function loadProfile() {
  try {
    const res = await fetch("https://battlepurse-18.onrender.com/api/wallet/profile", {
      headers: { Authorization: "Bearer " + token }
    });
    const data = await res.json();

    const u = data.user;
    username.innerText = u.name;
    mobile.innerText = u.phone;
    email.innerText = u.email || "Not set";
    userid.innerText = u.id;

    if (u.avatarUrl) avatarImg.src = u.avatarUrl;

    const ids = u.uids || {};
    ffid.value = ids.freeFire || "";
    bgmiid.value = ids.bgmi || "";
    carrom.value = ids.carrom || "";
    ludo.value = ids.ludo || "";

    if (u.isAdmin) {
      adminSection.style.display = "block";
    }

    const wbRes = await fetch("https://battlepurse-18.onrender.com/api/wallet/balance", {
      headers: { Authorization: "Bearer " + token }
    });
    const wb = await wbRes.json();
    wallet.innerText = wb.balance || 0;

  } catch (err) {
    console.error("Profile load error:", err);
    alert("Failed to load profile");
  }
}

/* ================= AVATAR UPLOAD ================= */
async function uploadAvatar() {
  const file = avatarInput.files[0];
  if (!file) return;

  if (!file.type.startsWith("image/")) {
    alert("Please select an image");
    return;
  }

  if (file.size > 2 * 1024 * 1024) {
    alert("Image must be less than 2MB");
    return;
  }

  avatarImg.src = URL.createObjectURL(file);

  const fd = new FormData();
  fd.append("avatar", file);

  try {
    const res = await fetch("https://battlepurse-18.onrender.com/api/wallet/upload-avatar", {
      method: "POST",
      headers: { Authorization: "Bearer " + token },
      body: fd
    });
    const d = await res.json();

    if (!res.ok || !d.success) {
      throw new Error(d.msg || "Upload failed");
    }

    avatarImg.src = d.url;
    alert("Avatar updated successfully");

  } catch (err) {
    console.error("Avatar upload error:", err);
    alert("Avatar upload failed");
  }
}

window.onload = loadProfile;
</script>

</body>
</html>
